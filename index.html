<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0B1220" />
  <title>Air&Bits — A330 Type Rating</title>
  <link rel="stylesheet" href="style.css?v=20260107a" />
</head>
<body>
  <header class="app-header">
    <div class="brand">
      <div class="brand-mark" aria-hidden="true">✈︎</div>
      <div class="brand-text">
        <div class="brand-title">Air&Bits</div>
        <div class="brand-subtitle">A330 · Type Rating</div>
      </div>
    </div>
  </header>

  <main class="app-main">
    <div id="app" class="app-root">
      <div class="card" style="max-width:760px;margin:18px auto;">
        <h2>Cargando…</h2>
        <p style="opacity:0.75;">Si esto no desaparece, hay un problema de caché (Service Worker) o un error JS. Esta versión lo detecta y lo muestra.</p>
        <pre id="bootlog" style="white-space:pre-wrap; font-size:12px; opacity:0.8;"></pre>
      </div>
    </div>
  </main>

  <script>
    // --- FIX iOS / GitHub Pages: evitar Service Worker viejo y cachés ---
    (async function() {
      const log = (m) => { const el = document.getElementById('bootlog'); if (el) el.textContent += m + "\n"; };
      try {
        if ('serviceWorker' in navigator) {
          const regs = await navigator.serviceWorker.getRegistrations();
          if (regs.length) {
            log("Service Worker detectado: desregistrando…");
            await Promise.all(regs.map(r => r.unregister()));
            log("OK. SW desregistrado.");
          } else {
            log("Sin Service Worker registrado.");
          }
        }
        if (window.caches && caches.keys) {
          const keys = await caches.keys();
          if (keys.length) {
            log("Caches detectadas: limpiando…");
            await Promise.all(keys.map(k => caches.delete(k)));
            log("OK. Cachés limpiadas.");
          } else {
            log("Sin cachés CacheStorage.");
          }
        }
      } catch (e) {
        log("Aviso: no se pudo limpiar caché/SW: " + (e && e.message ? e.message : e));
      }
    })();
  </script>

  <script src="app.js?v=20260107a"></script>

  <script>
    // --- BOOT robusto ---
    (function() {
      const showErr = (err) => {
        const app = document.getElementById('app');
        const msg = (err && (err.stack || err.message)) ? (err.stack || err.message) : String(err);
        app.innerHTML = `
          <div class="card" style="max-width:860px;margin:18px auto;">
            <h2>⚠️ Error cargando la app</h2>
            <p style="opacity:0.75;">Copia este error y pásamelo.</p>
            <pre style="white-space:pre-wrap; font-size:12px; background:rgba(0,0,0,0.25); padding:12px; border-radius:12px; overflow:auto;">${msg}</pre>
            <p style="opacity:0.75;">Si estabas usando PWA instalada, borra “Datos del sitio” o reinstala tras limpiar caché.</p>
          </div>
        `;
      };

      window.addEventListener('error', (e) => showErr(e.error || e.message));
      window.addEventListener('unhandledrejection', (e) => showErr(e.reason));

      document.addEventListener('DOMContentLoaded', () => {
        try {
          if (typeof initApp === 'function') initApp();
          // showMenu se llama dentro del flujo normal, pero lo forzamos por seguridad:
          if (typeof showMenu === 'function') showMenu();
        } catch (e) {
          showErr(e);
        }
      });
    })();
  </script>
</body>
</html>
